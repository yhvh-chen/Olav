# OLAV v0.8.2 开发进度周报 (2026-01-14)

**当前状态**: ✅ 已完成
**重点领域**: 目录重构、配置统一、功能补全

---

## 1. 核心架构改进：拓扑数据“导入时丰富” (Enrich-at-Import)

为了解决渲染侧逻辑过重且数据不全的问题，我们将数据处理前移至导入阶段。

### 原有问题
- 可视化脚本 (`topology_viz.py`) 需要在渲染时动态计算 BGP 类型、查找 OSPF 对应的 IP 等，逻辑复杂且脆弱。
- CDP/LLDP 只有物理接口，没有 IP 地址。
- OSPF 链路只有单侧信息完整。

### 解决方案：三阶段导入器
重构了 `TopologyImporter` (`src/olav/tools/topology_importer.py`)：

1.  **阶段一：收集 (Collect)**
    - 遍历所有 parsed JSON，收集原始链路数据。
    - 暂停插入数据库。

2.  **阶段二：交叉引用与丰富 (Cross-Reference)**
    - **OSPF**: 建立 `(local, remote)` 索引，反向查找对端接口和 IP，补全链路信息。
    - **CDP/LLDP**: 引入 ARP 表查找机制 (`_build_arp_tables`)，通过接口名标准化 (`Ethernet0/0` vs `Eth0/0`) 查找对应 IP 地址。
    - **BGP**: 在导入时根据 AS 号直接计算 `bgp_type` (iBGP/eBGP) 并存入元数据。

3.  **阶段三：验证与存储 (Insert)**
    - 使用 Pydantic 进行最终数据校验。
    - 将丰富后的元数据 (`local_ip`, `remote_ip`, `bgp_type`, `local_as` 等) 存入数据库 JSON 字段。

**结果**: Visualization 脚本现在只需从数据库“读取并展示”，不再需要进行复杂的业务逻辑计算。

---

## 2. 命令白名单升级：模板与安全机制

解决了 `show interface*` 等通配符命令在 Sync 过程中导致 "Invalid input" 的问题，同时保留了 Agent 的灵活性。

### 改进措施
1.  **移除通配符**: 从 `cisco_ios.txt` 白名单中移除了所有 `*` 结尾的命令。
2.  **引入模板机制**: 
    - 创建 `imports/commands/cisco_ios_templates.txt`。
    - 使用 `!VARIABLE` 语法 (如 `show interface !INTERFACE_NAME`) 替代 `$VARIABLE`。
3.  **三重安全保障**:
    - **Loader 过滤**: 自动忽略包含 `!` 的模板命令，防止进入 Sync 自动执行列表。
    - **Skill 教育**: 更新 Quik Query Skill，通过 Prompt 引导 Agent 将 `!VARIABLE` 替换为实际值。
    - **CLI 容错**: `!` 在 Cisco/Huawei CLI 中是注释符。即使 Agent 意外直接发送了模板，设备也会忽略该行，不会报错。

---

## 3. 可视化细节修复

基于用户反馈的针对性修复：
- **BGP**: 
    - 线条标签由 `BGP` 改为明确的 `iBGP` 或 `eBGP`。
    - Hover 信息移除 `N/A` 前缀，格式更整像。
- **OSPF**:
    - 线条标签采用双向接口风格 (如 `Gi1↔Gi2`)。
    - Hover 信息利用交叉引用数据，现在能显示两端的接口和 IP。
- **CDP**:
    - 利用新增的 ARP 表查找功能，现在能显示（部分）IP 地址。

---

## 4. 架构演进：废弃 Grep，拥抱 SQL 数据仓库

计划在后续版本 (v0.8.2+) 彻底改变数据检索方式，从基于文件的文本搜索进化为基于 SQL 的结构化查询。

### 核心变更
- **引入 Warehouse**: 利用 DuckDB 的 JSON 和全文检索能力，通过 `read_json_auto` 等函数直接将 `data/sync/` 目录下的 Parsed JSON 和 Raw Text 映射为数据库视图。
- **废弃工具 (Deprecated)**: 
    - 计划淘汰基于 `grep` 命令行的文件搜索工具 (`grep_search` 等)。
    - 原因：Grep 只能返回孤立文本行，无法处理结构化数据 (如 "找出 version < 12.0 的设备")，且无法进行跨设备关联分析。

### 实施路径
1.  **统一 Schema**: 定义 `device_snapshots` (JSON) 和 `raw_logs` (Text) 视图结构。
2.  **新工具**: 开发 `query_network_data(sql)` 工具，赋予 Agent 完整的 SQL 数据分析能力。
3.  **零拷贝**: 利用 DuckDB 零拷贝特性，直接查询文件系统，避免繁重的 ETL 过程。

---

## 5. 配置审计 (Configuration Audit)

**实施状态**: ✅ **已完成** - 硬编码配置已统一迁移至 `config/paths.py`。

### 实施内容 (v0.8.2)
新增 `config/paths.py` 模块，集中管理所有路径配置：

**数据库路径** (`.olav/db/`):
- ✅ `NETWORK_WAREHOUSE_PATH = .olav/db/network_warehouse.duckdb`
- ✅ `REGISTRY_PATH = .olav/db/registry.duckdb`
- ✅ `KNOWLEDGE_PATH = .olav/db/knowledge.duckdb`

**导出路径** (`exports/`):
- ✅ `EXPORTS_DIR = exports/`
- ✅ `SNAPSHOTS_DIR = exports/snapshots/`
- ✅ `SNAPSHOT_SYNC_DIR = exports/snapshots/sync/`
- ✅ `REPORTS_DIR = exports/reports/`
- ✅ `REPORTS_ANALYSIS_DIR = exports/reports/analysis/`
- ✅ `REPORTS_SNAPSHOTS_DIR = exports/reports/snapshots/`
- ✅ `VISUALIZATION_DIR = exports/visualizations/`
- ✅ `TOPOLOGY_VIZ_DIR = exports/visualizations/topology/`

**配置参数**:
- ✅ `LOG_ANALYSIS_WINDOW_HOURS = 24`
- ✅ `RETENTION_DAYS = 30`

### 使用方式
```python
from config.paths import NETWORK_WAREHOUSE_PATH, VISUALIZATION_DIR

# Old (hardcoded): db_path = ".olav/db/network_warehouse.duckdb"
# New (centralized): db_path = NETWORK_WAREHOUSE_PATH
```

### 向后兼容
提供了 Legacy 路径常量用于迁移脚本：
- `LEGACY_DATA_SYNC_DIR = data/sync/`
- `LEGACY_DATA_VIZ_DIR = data/visualizations/`
- `LEGACY_OLAV_DATA_DIR = .olav/data/`

---

## 6. Sync 功能机制深度分析

### 启动机制
- **入口**: 通过 `sync_all` 工具触发，通常绑定 CLI 的 `/sync` 命令。
- **流程**: 采用 **Stage 1 (Blocking) + Stage 2 (Async)** 双阶段设计。
  - Stage 1: Nornir 并发采集 (IO密集型)，阻塞返回。
  - Stage 2: 线程池后台处理 (CPU密集型)，含 Parsing、Report Generation、Topology Import。

### 回落与容错 (Fallback)
- **Query (智能混合)**: 计划调整为 **"Cache First, Real-time Fallback"** 策略。
  - *默认行为*: 优先查询 Sync 本地快照（毫秒级响应），极大提高查询效率。
  - *回落机制*: 若本地无数据，自动降级为实时连接设备采集。
  - *强制实时*: 仅当用户明确要求（如 "live", "real-time", "now"）时，才跳过缓存进行实时采集。
  - *实现路径*: 通过优化 Skill Prompt (如 `quick-query`) 引导 Agent 优先检查数据库，而非修改底层代码。
- **Analysis (宏观)**: 定位为基于 Sync 数据的全网/历史趋势分析工具，专注于宏观层面，不处理单点实时诊断。

### Diff 功能状态
- **状态**: 已启用 (`diff_configs` 工具存在)。
- **风险**: 路径配置可能存在不一致。
  - `sync_all` 输出路径: `raw/{device}/running-config.txt`
  - `diff_configs` 读取路径: `configs/{device}_running.txt`
  - **严重性**: 高。若无中间搬运逻辑，Diff 功能由于找不到文件将**完全失效**。需在本次发布前修复路径对齐问题。

---

## 7. 数据层与目录结构重构 (Refactoring - **已实施 v0.8.2**)

> **✅ 重构完成** (2026-01-14)  
> **实际状态**：  
> - 目录结构：`exports/snapshots/`, `exports/reports/`, `exports/visualizations/`  
> - 数据库统一存放：`.olav/db/` (network_warehouse.duckdb, registry.duckdb, knowledge.duckdb)  
> - Skill 名称：`network-snapshot` (原 `daily-sync`)  
> - CLI 命令：`/snapshot` (原 `/sync`)  

基于用户反馈，**已完成** 数据目录名称和结构的语义化重构，消除歧义并匹配实际功能。

### 核心变更建议
1.  **更名 `sync` -> `snapshots`**:
    - **原理**: `sync` 是动词（操作），`snapshot` 是名词（结果/制品）。
    - **动作层变更 (Skills/Commands)**:
        - Skill: `daily-sync` -> **`network-snapshot`** (强调生成快照的能力)
        - Command: `/sync` -> **`/snapshot`** (如 `/snapshot take`)
        - Workflow: `run_sync` -> **`create_snapshot`**
    - **制品层变更 (Directories)**: 
        - `data/sync/YYYY-MM-DD` -> `exports/snapshots/YYYY-MM-DD`

2.  **重组用户目录 (`data` -> `exports`)**:
    - **原理**: 根目录 `data/` 含义模糊，包含 raw logs、reports 和 viz。建议改为 `exports/`，明确这是用户可消费的输出。
    - **结构映射 (Skill-Based Mapping)**:
      ```text
      exports/
      ├── snapshots/        (← network-snapshot skill: 纯数据快照，Raw/Parsed)
      ├── reports/          (← 交付给人的 Markdown/PDF 报告)
      │   ├── snapshots/    (周期性快照报告, e.g., Daily Health Check)
      │   └── analysis/     (即时分析报告, e.g., BGP Troubleshooting)
      └── visualizations/   (← visualize skill: HTML 拓扑图)
      ```

3.  **解决 "Reports" 目录歧义**:
    - **问题**: `sync/.../reports` (存放过程元数据) 与 `data/reports` (存放最终报告) 易混淆。
    - **设计优化**: 
        - 快照内的元数据目录更名为 `meta/`。
        - 结构示例:
          ```text
          exports/snapshots/2026-01-14/
          ├── raw/          (CLI 原始输出)
          ├── parsed/       (JSON 结构化数据)
          ├── meta/         (原 reports: 存放 summary.json, process logs)
          └── db/           (可选: 该快照特定的 sqlite/duckdb dump)
          ```
        - `exports/reports/` 细分为 `analysis/` (专项分析) 和 `snapshots/` (例行巡检)，分别对应不同的 Skill 输出。

4.  **重组内部目录 (`.olav/data` -> `.olav/db`)**:
    - **原理**: `.olav/data` 实际存放的是 DuckDB 文件，更名为 `db` 更准确。
    - **数据库重命名**:
      - `topology.db` -> **`network_warehouse.duckdb`**: 存放拓扑、设备清单、Sync 元数据（不仅是拓扑）。
      - `capabilities.db` -> **`registry.duckdb`**: 存放 Command 定义、API 注册表。
      - `knowledge.db` -> **`knowledge.duckdb`**: 存放 RAG 向量和文档索引。

5.  **数据库文件审计**:
    - 发现存在文件碎片化问题，需归拢：
      - `data/sync/.../reports/topology.db` (Sync 生成的临时库) -> 应合并入 `network_warehouse.duckdb`。
      - `.olav/checkpoints.db` (LangGraph 状态) -> 移入 `.olav/db/`。

---

## 8. 已完成验证与提交记录

### 验证结果 (2026-01-14)
- [x] **全量 Sync 测试**: 已完成，2026-01-13 快照数据包含 6 台设备（R1-R4, SW1-SW2）的完整 Raw 和 Parsed 输出。
- [x] **可视化生成验证**: 已确认 HTML 拓扑图正确渲染新字段：
  - **BGP**: `iBGP`/`eBGP` 标签，Hover 显示 AS 号（如 `AS: 65000 ↔ 65001`）
  - **OSPF**: 双向接口标签（如 `Gi2↔Neighbor`），交叉引用的 IP 地址显示正常
  - **CDP**: ARP 表查找按预期工作，部分设备 IP 显示为 None（预期行为）
- [x] **拓扑数据库验证**: DuckDB 查询确认 20 条有效链路，元数据字段 (`local_ip`, `remote_ip`, `bgp_type`, `local_as`, `remote_as`) 正确填充。
- [x] **Agent 模板测试**: 已通过 Skill Prompt 引导验证，`!VARIABLE` 语法不会进入自动执行白名单。

### Git 提交记录
- **Commit**: `71c5f2e` - `feat(v0.8.1): fix diff_configs path and bump version`
  - 修复 `sync_tools.py` 中 `diff_configs` 的路径错误（`raw/` vs `configs/`）
  - 更新 `pyproject.toml` 版本号至 `0.8.1`
  - 添加完整的 `V0.8.1_STATUS_REPORT.md`
- **Branch**: `feature/v0.8.1-unified-data-layer`
- **待推送**: 是

### 历史提交
- `5cbc86c` - `feat(topology/cmds): refactor topology enrich-at-import and add safe command templates`
- `8fb3689` - `refactor: simplify topology visualization architecture`

### 已知未暂存文件
以下文件存在于工作区但未纳入 commit `71c5f2e`，已确认属于 v0.8.1 核心功能：
- **新增 Skills**: `daily-sync/` (注：v0.8.2 将重命名为 `network-snapshot`), `daily-report/`, `inspect-analyzer/`, `log-analyzer/`
- **新增 Workflows**: `.olav/workflows/`
- **新增 Commands**: `logs.py`, `sync.py`
- **新增核心模块**: `llm_interface.py`, `map_scheduler.py`, `event_tools.py`, `map_tools.py`
- **数据文件**: `data/sync/`, `data/visualizations/`, `data/e2e_test_backups/`

**建议**: 将测试数据和临时文件 (`nornir.log`, `run_*.py`) 加入 `.gitignore`，其余 Skills/Workflows 根据功能完整度决定是否纳入 v0.8.1 或推迟至 v0.8.2。

### 已知风险
- ARP 表查找依赖于 `show arp` 命令的输出，如果设备未配置或未采集 ARP 表，CDP 链路可能仍无 IP 显示（这是预期行为，已验证）。

---

## 9. 技术债务与待修复项 (Tech Debt)

### 代码中的 TODO 标记
- ~~`src/olav/tools/report_formatter.py:124` - 语言检测~~ ✅ **已解决** - 语言通过 Skill YAML 的 `output.language` 控制
- `src/olav/core/skill_loader.py:168` - 时间戳生成缺失 (低优先级)
- `src/olav/core/learning.py:180` - `_auto_embed_aliases` 函数未实现 (低优先级)

### 类型标注问题
- 多个测试文件存在 Pyright 类型错误 (89 处)，主要集中在：
  - `tests/e2e/test_complete_workflow.py`: 工具调用类型不完整
  - `test_regex_parser.py`: 返回类型标注缺失
- 建议在 v0.8.2 中统一修复类型标注。

### 版本号不同步
- `pyproject.toml` 中版本号为 `0.8.0`，应与 v0.8.1 保持一致。

### Skill/Workflow 命名一致性
- **当前状态**: `.olav/skills/daily-sync/` 与 `.olav/workflows/daily-run.md` 中 `sync_all()` 工具绑定。
- **v0.8.2 计划**: 根据第 7 章提议，将 `daily-sync` 重命名为 `network-snapshot`，同步更新 Workflow 引用。

---

## 10. v0.8.2 功能完成状态

### ✅ 已实现功能
1. **目录结构重构** - `exports/`, `.olav/db/` 语义化重组
2. **数据库统一存放** - 3 个 .duckdb 文件集中管理
3. **Skill/命令重命名** - `network-snapshot`, `/snapshot`
4. **配置统一管理** - 新增 `config/paths.py`
5. **数据归档工具** - `snapshot_retention_cleaner.py`
6. **Cron 触发配置** - 用户可编辑的 `config/cron.py`
7. **多语言报告** - 通过 Skill YAML `output.language` 控制
8. **Knowledge Embedding** - 完整的 Ollama/OpenAI 支持
9. **Map-Reduce 框架** - `llm_interface.py`, `map_scheduler.py`

### ⚠️ 待验证功能
- **Map-Reduce Workflow 集成** - daily-run Stage 3/4 端到端调用路径
- **Cron 调度器实现** - 需基于 APScheduler 或 schedule 库实现 Runner
- **Subagent 委派** - DeepAgents 框架集成验证

### ❌ 未实现功能 (推迟至 v0.9.0)
- **SQL 数据仓库** - `query_network_data(sql)` 工具
- **LLM 流式输出** - LangChain Streaming 集成
- **类型标注修复** - 89 处 Pyright 错误

---

## 11. v0.8.2 最终交付清单

### 核心功能 (v0.8.1 → v0.8.2)
| 功能 | 状态 | 说明 |
|:---|:---:|:---|
| 拓扑"导入时丰富" | ✅ | ARP查找、OSPF交叉引用、BGP类型计算 |
| 命令模板安全机制 | ✅ | `!VARIABLE` 语法 + 三重安全保障 |
| 目录语义化重构 | ✅ | `exports/`, `.olav/db/` |
| 配置统一管理 | ✅ | `config/paths.py` |
| 数据归档 | ✅ | `snapshot_retention_cleaner.py` |
| Cron 配置 | ✅ | `config/cron.py` (用户可编辑) |
| 多语言支持 | ✅ | Skill YAML 控制，无需代码 |

### 技术债务清理
| 项目 | 状态 | 说明 |
|:---|:---:|:---|
| TODO 标记清理 | ⚠️ | 3个 → 2个 (report_formatter 已解决) |
| 路径硬编码 | ✅ | 全部迁移至 config/paths.py |
| 版本号同步 | ✅ | pyproject.toml = 0.8.2 |
| 类型标注 | ❌ | 89处错误推迟至 v0.8.4 |

---

## 12. 开发路线图 (Roadmap)

### v0.8.2 (Current Release - 2026-01-14)
**🎯 主题**: 配置统一化 + 数据管理完善

**已完成**:
- ✅ 目录结构重构 (`exports/`, `.olav/db/`)
- ✅ 配置统一管理 (`config/paths.py`)
- ✅ 数据归档工具 (`snapshot_retention_cleaner.py`)
- ✅ Cron 触发配置 (`config/cron.py`)
- ✅ 多语言支持 (Skill YAML 控制)

**待验证**:
- ⚠️ Map-Reduce 端到端调用路径
- ⚠️ Cron 调度器实现 (APScheduler)

### v0.8.3 (Future)
**🎯 主题**: SQL 数据仓库 + LLM 增强

**规划功能**:
- [ ] `query_network_data(sql)` 工具 - DuckDB SQL 查询接口
- [ ] LLM 流式输出 - LangChain Streaming 集成
- [ ] Subagent 委派验证 - DeepAgents 框架完整集成

### v0.8.4 (Technical Debt)
**🎯 主题**: 代码质量提升

**规划任务**:
- [ ] 类型标注修复 (89 处 Pyright 错误)
- [ ] 测试覆盖率提升 (目标 80%)
- [ ] 文档完善 (API 参考 + 示例)

### v0.8.1 - 当前发布 (本周内)
**目标**: 修复阻塞性问题，完成已开发功能的验证。

| 优先级 | 任务 | 状态 |
|:---:|:---|:---:|
| P0 | 修复 `diff_configs` 路径不匹配问题 | ✅ 已完成 (71c5f2e) |
| P0 | 全量 Sync + 拓扑可视化 E2E 验证 | ✅ 已验证 |
| P1 | 更新 `pyproject.toml` 版本号至 `0.8.1` | ✅ 已完成 (71c5f2e) |
| P1 | 验证 Agent 正确替换 `!VARIABLE` 模板 | ✅ 已验证 |
| P2 | 推送分支到远程 | ✅ 已完成 (83452be) |

### v0.8.2 - 数据层重构 (已完成 2026-01-14)
**目标**: 实现语义化目录结构，数据库统一存放。

**实施内容** (commit 83452be):
- ✅ 目录重构: `exports/snapshots/`, `exports/reports/`, `exports/visualizations/`
- ✅ 数据库统一: `.olav/db/` (network_warehouse.duckdb, registry.duckdb, knowledge.duckdb)
- ✅ Skill 重命名: `daily-sync` → `network-snapshot` (v2.0.0)
- ✅ 命令重命名: `/sync` → `/snapshot`
- ✅ 代码路径更新: 12+ 文件路径引用更新
- ✅ 配置更新: .gitignore, V0.8.1_STATUS_REPORT.md

### v0.8.3 - 配置外移与功能补全 (计划 2 周)
### v0.8.3 - 配置外移与功能补全 (计划 2 周)
**目标**: 硬编码配置迁移至 settings，实现缺失功能。

**Week 1**: 配置外移 (实施第 5 章审计)
- [ ] 添加到 settings.py:
  - `NETWORK_WAREHOUSE_PATH = .olav/db/network_warehouse.duckdb`
  - `VISUALIZATION_DIR = exports/visualizations`
  - `LOG_ANALYSIS_WINDOW_HOURS = 24`
  - `RETENTION_DAYS = 30`
  - `EXPORTS_DIR = exports`
  - `SNAPSHOTS_DIR = exports/snapshots`
  - `REPORTS_ANALYSIS_DIR = exports/reports/analysis`
  - `REPORTS_SNAPSHOTS_DIR = exports/reports/snapshots`
- [ ] 更新代码使用 settings 变量 (5+ 文件)
- [ ] 更新 `knowledge_db_path` 路径为新的 `.olav/db/knowledge.duckdb`

**Week 2**: 功能补全
- [ ] 实现数据归档工具 (snapshot_retention_cleaner)
- [ ] 实现 Cron 调度器 (基于 APScheduler 或 schedule)
- [ ] 验证 Map-Reduce workflow 端到端调用
- [ ] 技术债务清理 (3 个 TODO 标记)

### v0.8.4 - 类型标注修复 (1 周)
- [ ] 修复 89 处 Pyright 类型错误
  - `tests/e2e/test_complete_workflow.py`: 工具调用类型
  - `test_regex_parser.py`: 返回类型标注
- [ ] 统一类型标注规范

### v0.8.4 - 类型标注修复 (1 周)
- [ ] 修复 89 处 Pyright 类型错误
  - `tests/e2e/test_complete_workflow.py`: 工具调用类型
  - `test_regex_parser.py`: 返回类型标注
- [ ] 统一类型标注规范

### v0.9.0 - 生产化与 SQL 数据仓库 (4 周)
**目标**: 生产就绪，SQL 查询能力，流式输出。

**Week 1-2**: SQL 数据仓库
- [ ] 实现 `query_network_data(sql)` 工具
- [ ] 定义统一 Schema (device_snapshots, raw_logs 视图)
- [ ] 利用 DuckDB 零拷贝查询 JSON/Text 文件

**Week 3**: LLM 流式输出
- [ ] 集成 LangChain Streaming
- [ ] 更新 CLI 显示流式响应

**Week 4**: 生产化
- [ ] Docker 镜像优化
- [ ] API Server (FastAPI)
- [ ] 文档站点 (MkDocs)
- [ ] CI/CD Pipeline

---

## 12. 风险与依赖

| 风险 | 影响 | 缓解措施 |
|:---|:---|:---|
| 目录重构影响现有用户数据 | 高 | 提供迁移脚本 |
| DuckDB 版本兼容性 | 中 | 锁定 `duckdb>=0.8.0,<1.0` |
| LLM Provider API 变更 | 中 | 抽象层隔离 (`LLMFactory`) |
