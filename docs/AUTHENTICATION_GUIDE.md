# OLAV Authentication Guide

## ğŸ¯ è®¤è¯æœºåˆ¶è¯´æ˜

OLAV ä½¿ç”¨åŸºäº Token çš„è®¤è¯æœºåˆ¶ï¼Œä½†**é»˜è®¤åœ¨å¼€å‘/æµ‹è¯•æ¨¡å¼ä¸‹ç¦ç”¨è®¤è¯**ã€‚

### è®¤è¯çŠ¶æ€æ€»è§ˆ

| æ¨¡å¼ | AUTH_DISABLED | è®¤è¯çŠ¶æ€ | é€‚ç”¨åœºæ™¯ |
|------|---------------|---------|---------|
| **QuickTest** | `true` (é»˜è®¤) | âŒ ç¦ç”¨ | æœ¬åœ°å¼€å‘ã€æµ‹è¯• |
| **Production** | `false` (æ¨è) | âœ… å¯ç”¨ | ç”Ÿäº§ç¯å¢ƒ |

---

## ğŸ” QuickTest æ¨¡å¼ï¼ˆé»˜è®¤ - è®¤è¯ç¦ç”¨ï¼‰

### é…ç½®

```yaml
# docker-compose.yml
environment:
  AUTH_DISABLED: true  # â† é»˜è®¤å€¼
```

```dotenv
# .env (QuickTest æ¨¡å¼)
# AUTH_DISABLED=true  # æ³¨é‡Šæ‰è¡¨ç¤ºä½¿ç”¨ docker-compose é»˜è®¤å€¼
# OLAV_API_TOKEN=     # QuickTest æ¨¡å¼ä¸éœ€è¦
```

### è¡Œä¸º

```python
# src/olav/server/auth.py
async def get_current_user(...):
    if _is_auth_disabled():  # AUTH_DISABLED=true
        return User(username="admin", role=UserRole.ADMIN.value)
        # â†‘ ç›´æ¥è¿”å› admin ç”¨æˆ·ï¼Œä¸éªŒè¯ä»»ä½• token
```

**ç‰¹ç‚¹**ï¼š
- âœ… CLI æ— éœ€ä»»ä½• token å³å¯è¿æ¥
- âœ… æ‰€æœ‰è¯·æ±‚éƒ½ä»¥ admin èº«ä»½æ‰§è¡Œ
- âœ… é€‚åˆæœ¬åœ°å¼€å‘å’Œå¿«é€Ÿæµ‹è¯•
- âŒ **ä¸å®‰å…¨**ï¼Œç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨

---

## ğŸ”’ Production æ¨¡å¼ï¼ˆè®¤è¯å¯ç”¨ï¼‰

### 1. é…ç½® .env

è¿è¡Œ `setup.ps1` é€‰æ‹© Production æ¨¡å¼åï¼Œä¼šç”Ÿæˆï¼š

```dotenv
# .env (Production æ¨¡å¼)
# OLAV Server Authentication
OLAV_API_TOKEN=<auto-generated-base64-token>
AUTH_DISABLED=false  # å¯ç”¨è®¤è¯
```

æˆ–è€…æ‰‹åŠ¨ç”Ÿæˆ tokenï¼š

```powershell
# PowerShell
$token = [System.Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
Write-Host "OLAV_API_TOKEN=$token"
```

```bash
# Linux/Mac
openssl rand -base64 32
```

### 2. å¯åŠ¨ Server

```bash
docker-compose up -d olav-server
```

Server å¯åŠ¨æ—¶ä¼šæ‰“å° Master Tokenï¼š

```
ğŸ”‘ ACCESS TOKEN (valid for 24 hours):
   abc123xyz789...
```

**æ³¨æ„**ï¼š
- å¦‚æœ `.env` ä¸­æœ‰ `OLAV_API_TOKEN`ï¼Œä½¿ç”¨ .env çš„å€¼
- å¦‚æœ `.env` ä¸­æ²¡æœ‰ï¼Œserver ä¼šè‡ªåŠ¨ç”Ÿæˆä¸´æ—¶ token

### 3. Client æ³¨å†Œ

```bash
# ä½¿ç”¨ Master Token æ³¨å†Œå®¢æˆ·ç«¯
olav register --name "my-laptop" --token "abc123xyz789..."

# è¾“å‡ºï¼š
# âœ… Registration successful!
#    Client ID: 550e8400-e29b-41d4-a716-446655440000
#    Client Name: my-laptop
#    Session Token saved to ~/.olav/credentials
```

### 4. åç»­ä½¿ç”¨

Client è‡ªåŠ¨ä» `~/.olav/credentials` è¯»å– session tokenï¼š

```bash
# æ— éœ€æ‰‹åŠ¨æŒ‡å®š token
olav query "show interfaces"

# Token ä¼˜å…ˆçº§ï¼š
# 1. $env:OLAV_API_TOKEN (ç¯å¢ƒå˜é‡)
# 2. OLAV_API_TOKEN from .env
# 3. OLAV_SESSION_TOKEN from ~/.olav/credentials
```

---

## ğŸ”„ ä¸¤ç§ Token çš„åŒºåˆ«

### Master Token (OLAV_API_TOKEN)

```python
# ç”Ÿæˆä½ç½®
# 1. .env æ–‡ä»¶ä¸­é¢„è®¾ï¼ˆProduction æ¨¡å¼ï¼‰
# 2. Server å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚æœ .env æ²¡æœ‰ï¼‰

# ç”¨é€”
# - ç”¨äº client æ³¨å†Œ
# - ç®¡ç†å‘˜ç›´æ¥è®¿é—® API
# - æœ‰æ•ˆæœŸï¼š24 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰

# è§’è‰²
# - å›ºå®šä¸º admin è§’è‰²
# - å®Œå…¨æƒé™
```

### Session Token (OLAV_SESSION_TOKEN)

```python
# ç”Ÿæˆä½ç½®
# - Client æ³¨å†Œæ—¶ï¼Œserver è¿”å›

# ç”¨é€”
# - Client æ—¥å¸¸ API è¯·æ±‚
# - æ”¯æŒå¤šä¸ª client ç‹¬ç«‹è¿½è¸ª

# è§’è‰²
# - æ³¨å†Œæ—¶æŒ‡å®šï¼ˆadmin/operator/viewerï¼‰
# - é»˜è®¤ operator è§’è‰²
# - æœ‰æ•ˆæœŸï¼š168 å°æ—¶ï¼ˆ7 å¤©ï¼Œå¯é…ç½®ï¼‰
```

---

## ğŸ›ï¸ è§’è‰²æƒé™

### Admin
- âœ… æ‰€æœ‰è¯»æ“ä½œ
- âœ… æ‰€æœ‰å†™æ“ä½œï¼ˆè·³è¿‡ HITL å®¡æ‰¹ï¼‰
- âœ… è®¿é—®æ‰€æœ‰ workflow

### Operator
- âœ… æ‰€æœ‰è¯»æ“ä½œ
- âœ… å†™æ“ä½œï¼ˆéœ€è¦ HITL äººå·¥ç¡®è®¤ï¼‰
- âœ… è®¿é—®å¤§éƒ¨åˆ† workflow
- âŒ æŸäº›é«˜å±æ“ä½œéœ€è¦ admin

### Viewer
- âœ… åªè¯»æ“ä½œ
- âŒ ä¸èƒ½è§¦å‘å†™æ“ä½œ
- âŒ ä¸èƒ½è®¿é—® DeviceExecution, NetBoxManagement, DeepDive

---

## ğŸ“ é…ç½®æ–‡ä»¶å¯¹æ¯”

### QuickTest .env
```dotenv
# ============================================
# OLAV Configuration (Quick Test Mode)
# ============================================

OLAV_MODE=quicktest

# ... å…¶ä»–é…ç½® ...

# OLAV Server Authentication
# AUTH_DISABLED=true  # æ³¨é‡Šæ‰ = ä½¿ç”¨ docker-compose é»˜è®¤å€¼
# OLAV_API_TOKEN=     # QuickTest ä¸éœ€è¦é¢„è®¾
```

### Production .env
```dotenv
# ============================================
# OLAV Configuration (Production Mode)
# ============================================

OLAV_MODE=production

# ... å…¶ä»–é…ç½® ...

# OLAV Server Authentication
OLAV_API_TOKEN=aB3xCd9eF2gHiJk1LmN4oPqRsT6uVwXyZ8aB0cDeFgHi==
AUTH_DISABLED=false  # å¯ç”¨è®¤è¯
```

---

## ğŸš€ å¿«é€Ÿåˆ‡æ¢æ¨¡å¼

### ä» QuickTest åˆ‡æ¢åˆ° Production

1. **æ›´æ–° .env**ï¼š
   ```dotenv
   # æ·»åŠ è¿™ä¸¤è¡Œ
   OLAV_API_TOKEN=<ç”Ÿæˆçš„token>
   AUTH_DISABLED=false
   ```

2. **é‡å¯å®¹å™¨**ï¼š
   ```bash
   docker-compose restart olav-server
   ```

3. **æ³¨å†Œ Client**ï¼š
   ```bash
   # ä½¿ç”¨ .env ä¸­çš„ token
   olav register --name "prod-client" --token "$env:OLAV_API_TOKEN"
   ```

### ä» Production åˆ‡æ¢å› QuickTestï¼ˆæµ‹è¯•ï¼‰

1. **æ›´æ–° docker-compose.yml æˆ– .env**ï¼š
   ```yaml
   environment:
     AUTH_DISABLED: true  # ä¸´æ—¶ç¦ç”¨è®¤è¯
   ```

2. **é‡å¯**ï¼š
   ```bash
   docker-compose restart olav-server
   ```

---

## ğŸ” éªŒè¯è®¤è¯çŠ¶æ€

### æ£€æŸ¥ Server è®¤è¯çŠ¶æ€

```bash
# æŸ¥çœ‹ server æ—¥å¿—
docker logs olav-server | grep -i "auth\|token"

# è¾“å‡ºç¤ºä¾‹ï¼ˆè®¤è¯å¯ç”¨ï¼‰ï¼š
# ğŸ”‘ ACCESS TOKEN (valid for 24 hours):
#    abc123xyz...

# è¾“å‡ºç¤ºä¾‹ï¼ˆè®¤è¯ç¦ç”¨ï¼‰ï¼š
# âš ï¸ Authentication disabled (AUTH_DISABLED=true)
```

### æµ‹è¯• API è®¿é—®

```bash
# è®¤è¯ç¦ç”¨æ—¶ï¼ˆæ— éœ€ tokenï¼‰
curl http://localhost:8001/health

# è®¤è¯å¯ç”¨æ—¶ï¼ˆéœ€è¦ tokenï¼‰
curl http://localhost:8001/health
# è¿”å›: 401 Unauthorized

curl -H "Authorization: Bearer <your-token>" http://localhost:8001/health
# è¿”å›: {"status":"healthy",...}
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: CLI æç¤º "Invalid or expired token"
**åŸå› **: AUTH_DISABLED=false ä½†æ²¡æœ‰æœ‰æ•ˆ token

**è§£å†³**:
```bash
# é‡æ–°æ³¨å†Œ
olav register --name "my-client" --token "$env:OLAV_API_TOKEN"
```

### Q2: Server æ¯æ¬¡é‡å¯ token éƒ½å˜
**åŸå› **: .env ä¸­æ²¡æœ‰é¢„è®¾ OLAV_API_TOKEN

**è§£å†³**:
```dotenv
# .env ä¸­æ·»åŠ å›ºå®š token
OLAV_API_TOKEN=<å›ºå®šçš„base64å€¼>
```

### Q3: Session token è¿‡æœŸ
**åŸå› **: é»˜è®¤ 7 å¤©æœ‰æ•ˆæœŸ

**è§£å†³**:
```bash
# é‡æ–°æ³¨å†Œ
olav register --name "my-client" --token "$env:OLAV_API_TOKEN"
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `src/olav/server/auth.py` | è®¤è¯é€»è¾‘å®ç° |
| `src/olav/cli/commands.py` | CLI æ³¨å†Œå‘½ä»¤ |
| `setup.ps1` | ç”Ÿæˆ OLAV_API_TOKEN |
| `docker-compose.yml` | AUTH_DISABLED ç¯å¢ƒå˜é‡ |
| `.env` | é…ç½®æ–‡ä»¶ |
| `~/.olav/credentials` | Client session token å­˜å‚¨ |

---

## ğŸ“ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ
```dotenv
# .env
AUTH_DISABLED=true  # æˆ–ä¸è®¾ç½®ï¼ˆä½¿ç”¨ docker-compose é»˜è®¤å€¼ï¼‰
# å¿«é€Ÿè¿­ä»£ï¼Œæ— éœ€è®¤è¯
```

### æµ‹è¯•ç¯å¢ƒ
```dotenv
# .env
OLAV_API_TOKEN=<å›ºå®šæµ‹è¯•token>
AUTH_DISABLED=false
# æµ‹è¯•å®Œæ•´è®¤è¯æµç¨‹
```

### ç”Ÿäº§ç¯å¢ƒ
```dotenv
# .env
OLAV_API_TOKEN=<å¼ºéšæœºtoken>
AUTH_DISABLED=false
# å¯ç”¨è®¤è¯ + ä½¿ç”¨ operator è§’è‰² + HITL å®¡æ‰¹
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```yaml
# docker-compose.yml
environment:
  LOG_LEVEL: DEBUG  # æŸ¥çœ‹è¯¦ç»†è®¤è¯æ—¥å¿—
```

### æ£€æŸ¥ token éªŒè¯é€»è¾‘

```python
# src/olav/server/auth.py
def validate_token(token: str) -> tuple[bool, dict | None]:
    # æ£€æŸ¥è¿™é‡Œçš„æ—¥å¿—è¾“å‡º
    logger.debug(f"Validating token: {token[:10]}...")
```

---

## ğŸ“– å‚è€ƒ

- **RFC 6750**: Bearer Token Usage
- **LangGraph Authentication**: [å®˜æ–¹æ–‡æ¡£](https://python.langchain.com/docs/langgraph)
- **FastAPI Security**: [å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/tutorial/security/)
