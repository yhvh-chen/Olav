# OLAV Syslog Collector Configuration
# Receives UDP/TCP syslog from network devices and forwards to OpenSearch
#
# Usage: Configure network devices to send syslog to this collector:
#   - UDP port 514 (standard syslog)
#   - TCP port 514 (reliable syslog)
#
# Logs are stored in OpenSearch 'syslog-raw' index with minimal parsing.

#################
# GLOBAL CONFIG #
#################

# Set max message size (network devices may send long messages)
$MaxMessageSize 64k

# Work directory for queue files
$WorkDirectory /var/lib/rsyslog

#################
# INPUT MODULES #
#################

# Load UDP input module
module(load="imudp")
input(type="imudp" port="514" ruleset="network_devices")

# Load TCP input module (for reliable delivery)
module(load="imtcp")
input(type="imtcp" port="514" ruleset="network_devices")

#################
# OUTPUT MODULE #
#################

# Load OpenSearch/Elasticsearch output module
module(load="omelasticsearch")

##################
# JSON TEMPLATES #
##################

# Minimal JSON template - no complex parsing, preserve raw message
# Fields:
#   - @timestamp: RFC3339 timestamp for time-based queries
#   - device_ip: Source IP for device filtering
#   - facility: Syslog facility (kern, user, daemon, local0-7, etc.)
#   - severity: Syslog severity (emerg, alert, crit, err, warning, notice, info, debug)
#   - raw_message: Original message text (full-text indexed)

template(name="syslog-json" type="list") {
    constant(value="{")
    constant(value="\"@timestamp\":\"")
    property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"device_ip\":\"")
    property(name="fromhost-ip")
    constant(value="\",\"facility\":\"")
    property(name="syslogfacility-text")
    constant(value="\",\"severity\":\"")
    property(name="syslogseverity-text")
    constant(value="\",\"program\":\"")
    property(name="programname")
    constant(value="\",\"raw_message\":")
    property(name="rawmsg" format="jsonf")
    constant(value="}")
}

# Index name template (daily rotation for easier management)
template(name="syslog-index" type="string" string="syslog-raw")

##################
# RULESETS       #
##################

ruleset(name="network_devices") {
    # Send to OpenSearch with buffering and retry
    action(
        type="omelasticsearch"
        name="opensearch_output"
        
        # OpenSearch connection
        server="opensearch"
        serverport="9200"
        
        # Index configuration
        searchIndex="syslog-raw"
        template="syslog-json"
        
        # Disable _type parameter (OpenSearch 2.x doesn't support it)
        usehttps="off"
        
        # Bulk mode for better performance
        bulkmode="on"
        bulkid="off"
        
        # Queue configuration for reliability
        queue.type="linkedlist"
        queue.size="50000"
        queue.dequeuebatchsize="1000"
        queue.workerThreads="4"
        queue.saveonshutdown="on"
        queue.filename="opensearch_queue"
        
        # Retry on failure
        action.resumeretrycount="-1"
        action.resumeinterval="10"
        
        # Error handling
        errorfile="/var/log/rsyslog/opensearch-errors.log"
    )
    
    # Also log to local file for debugging (optional, can be disabled)
    action(
        type="omfile"
        file="/var/log/rsyslog/network.log"
        template="RSYSLOG_TraditionalFileFormat"
    )
}

##################
# DEFAULT RULES  #
##################

# Log rsyslog internal messages
*.info /var/log/rsyslog/rsyslog.log
