apiVersion: v1
kind: Namespace
metadata:
  name: olav
  labels:
    app: olav
    version: v0.8

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: olav-config
  namespace: olav
data:
  settings.json: |
    {
      "llmModelName": "gpt-4",
      "llmTemperature": 0.7,
      "routingConfidenceThreshold": 0.7,
      "hiltRequireApprovalForWrite": false,
      "diagnosisMacroMaxConfidence": 0.9,
      "diagnosisMicroMaxConfidence": 0.85,
      "loggingLevel": "INFO",
      "loggingAuditEnabled": true,
      "guardEnabled": true,
      "guardStrictMode": false
    }
  
  logging-config.yaml: |
    version: 1
    disable_existing_loggers: false
    formatters:
      standard:
        format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    handlers:
      console:
        class: logging.StreamHandler
        level: INFO
        formatter: standard
    root:
      level: INFO
      handlers: [console]

---
apiVersion: v1
kind: Secret
metadata:
  name: olav-secrets
  namespace: olav
type: Opaque
stringData:
  # These should be injected from your secret management system (HashiCorp Vault, AWS Secrets Manager, etc.)
  OPENAI_API_KEY: "your-openai-api-key-here"
  POSTGRES_PASSWORD: "secure-postgres-password"
  REDIS_PASSWORD: "secure-redis-password"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: olav-config-pvc
  namespace: olav
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: olav-data-pvc
  namespace: olav
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: olav-agent
  namespace: olav
  labels:
    app: olav
    version: v0.8
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  selector:
    matchLabels:
      app: olav
      component: agent
  
  template:
    metadata:
      labels:
        app: olav
        component: agent
        version: v0.8
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    
    spec:
      serviceAccountName: olav
      
      # Init container for migration (Phase C-3)
      initContainers:
      - name: migrate-config
        image: olav:0.8
        imagePullPolicy: IfNotPresent
        command: ["python", "-m", "scripts.verify_claude_compat_enhanced"]
        volumeMounts:
        - name: config-volume
          mountPath: /app/.olav
        env:
        - name: LOG_LEVEL
          value: "INFO"
      
      containers:
      - name: olav-agent
        image: olav:0.8
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: cli
          containerPort: 8000
          protocol: TCP
        
        env:
        # Configuration from Phase C-1
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: olav-config
              key: logging-config.yaml
        
        # API Keys from secrets
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: olav-secrets
              key: OPENAI_API_KEY
        
        # Database connections
        - name: POSTGRES_HOST
          value: postgres-service
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_USER
          value: olav
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: olav-secrets
              key: POSTGRES_PASSWORD
        - name: POSTGRES_DB
          value: olav_store
        
        # Redis cache
        - name: REDIS_HOST
          value: redis-service
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: olav-secrets
              key: REDIS_PASSWORD
        
        # Ollama LLM
        - name: OLLAMA_BASE_URL
          value: http://ollama-service:11434
        
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"
        
        volumeMounts:
        - name: config-volume
          mountPath: /app/.olav
        - name: data-volume
          mountPath: /app/data
        
        # Health checks (Phase C-3 validation)
        livenessProbe:
          exec:
            command:
            - python
            - -c
            - "import sys; sys.exit(0)"
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          exec:
            command:
            - python
            - -c
            - "import sys; sys.exit(0)"
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
              - ALL
      
      volumes:
      - name: config-volume
        persistentVolumeClaim:
          claimName: olav-config-pvc
      - name: data-volume
        persistentVolumeClaim:
          claimName: olav-data-pvc
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - olav
              topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: Service
metadata:
  name: olav-service
  namespace: olav
  labels:
    app: olav
spec:
  type: ClusterIP
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: cli
  selector:
    app: olav
    component: agent

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: olav
  namespace: olav

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: olav-role
  namespace: olav
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: olav-rolebinding
  namespace: olav
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: olav-role
subjects:
- kind: ServiceAccount
  name: olav
  namespace: olav

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: olav-hpa
  namespace: olav
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: olav-agent
  minReplicas: 1
  maxReplicas: 3
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
